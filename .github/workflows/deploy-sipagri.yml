name: üöÄ Build and Deploy SipAGRI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Emp√™che le d√©ploiement concurrent sur le m√™me serveur
    concurrency: 
      group: production-deploy
      cancel-in-progress: false

    steps:
      # √âtape 1: R√©cup√©rer le code
      - name: Checkout code
        uses: actions/checkout@v4

      # √âtape 2: Configurer Java et Maven
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # √âtape 3: Builder le projet avec Maven (cela cr√©e le fichier JAR dans target/)
      - name: Build with Maven
        run: mvn -B package --file pom.xml
        # L'option -B est pour le mode batch (non interactif)

      # √âtape 4: Copier le JAR vers le dossier TEMP du serveur
      - name: Copy JAR to Temp Directory
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          source: "target/*.jar"
          target: "/tmp/"
          strip_components: 1
      
      # √âtape 5: D√©placer, archiver et red√©marrer
      - name: Deploy, Archive and Restart Service
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            # Chemins (NOTE: /tmp/ sur Windows est en fait C:\Windows\Temp\)
            $JAR_SOURCE = "C:\Windows\Temp\*.jar"  # Chemin Windows pour /tmp/
            $DEPLOY_DIR = "${{ secrets.SERVER_JAR_PATH }}"
            $ARCHIVE_DIR = "$DEPLOY_DIR\MAJ"
            $SERVICE_NAME = "${{ secrets.NSSM_SERVICE_NAME }}"
                $DATE = Get-Date -Format "yyyy.MM.dd"
                $TODAY_ARCHIVE = "$ARCHIVE_DIR\$DATE"
                
                # Cr√©ation des dossiers
                New-Item -ItemType Directory -Path $ARCHIVE_DIR -Force -ErrorAction SilentlyContinue
                New-Item -ItemType Directory -Path $TODAY_ARCHIVE -Force -ErrorAction SilentlyContinue
                
                Write-Output "‚èπÔ∏è  Arr√™t du service..."
                nssm stop $SERVICE_NAME
                Start-Sleep -Seconds 5
                
                # Archivage des anciens JAR
                $OLD_JARS = Get-ChildItem -Path $DEPLOY_DIR -Filter "*.jar" -ErrorAction SilentlyContinue
                if ($OLD_JARS) {
                    Write-Output "üì¶ Archivage des anciennes versions..."
                    foreach ($JAR in $OLD_JARS) {
                        $ARCHIVE_PATH = "$TODAY_ARCHIVE\$($JAR.Name)"
                        Move-Item -Path $JAR.FullName -Destination $ARCHIVE_PATH -Force
                        Write-Output "‚úÖ Archiv√©: $($JAR.Name)"
                    }
                }
                
                # D√©ploiement du nouveau JAR
                Write-Output "üöÄ D√©ploiement de la nouvelle version..."
                $NEW_JAR = Get-ChildItem -Path $JAR_SOURCE
                if ($NEW_JAR) {
                    Move-Item -Path $NEW_JAR.FullName -Destination $DEPLOY_DIR -Force
                    Write-Output "‚úÖ D√©ploy√©: $($NEW_JAR.Name)"
                } else {
                    throw "‚ùå Aucun fichier JAR trouv√© dans /tmp/"
                }
                
                # Red√©marrage du service
                Write-Output "üîÑ D√©marrage du service..."
                nssm start $SERVICE_NAME
                Start-Sleep -Seconds 2
                
                # V√©rification finale
                Write-Output "üìä Statut du service:"
                nssm status $SERVICE_NAME
                
                Write-Output "`n‚úÖ D√©ploiement termin√© avec succ√®s!"
                
            } catch {
                Write-Output "‚ùå Erreur lors du d√©ploiement: $($_.Exception.Message)"
                exit 1
            }
