name: üöÄ Build and Deploy SipAGRI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    concurrency: 
      group: production-deploy
      cancel-in-progress: false

    steps:
      # √âtape 1: R√©cup√©rer le code
      - name: Checkout code
        uses: actions/checkout@v4

      # √âtape 2: Configurer Java et Maven
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # √âtape 3: Builder le projet avec Maven
      - name: Build with Maven
        run: mvn -B package --file pom.xml

      # √âtape 4: Copier le JAR vers le dossier TEMP du serveur
      - name: Copy JAR to Temp Directory
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          source: "target/*.jar"
          target: "/tmp/"
          strip_components: 1
      
      # √âtape 5: D√©placer, archiver et red√©marrer (VERSION CORRIG√âE)
      - name: Deploy, Archive and Restart Service
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            try {
                # Chemins (NOTE: /tmp/ sur Windows est en fait C:\Windows\Temp\)
                $JAR_SOURCE = "C:\Windows\Temp\*.jar"
                $DEPLOY_DIR = "${{ secrets.SERVER_JAR_PATH }}"
                $ARCHIVE_DIR = "$DEPLOY_DIR\MAJ"
                $SERVICE_NAME = "${{ secrets.NSSM_SERVICE_NAME }}"
                $DATE = Get-Date -Format "yyyy.MM.dd"
                $TODAY_ARCHIVE = "$ARCHIVE_DIR\$DATE"
                
                # Cr√©ation des dossiers
                Write-Output "üìÅ Cr√©ation des dossiers d'archive..."
                New-Item -ItemType Directory -Path $ARCHIVE_DIR -Force -ErrorAction SilentlyContinue
                New-Item -ItemType Directory -Path $TODAY_ARCHIVE -Force -ErrorAction SilentlyContinue
                
                Write-Output "‚èπÔ∏è  Arr√™t du service $SERVICE_NAME..."
                C:\nssm\win64\nssm.exe stop $SERVICE_NAME
                Start-Sleep -Seconds 5
                
                # Archivage des anciens JAR
                Write-Output "üì¶ Recherche des anciennes versions..."
                $OLD_JARS = Get-ChildItem -Path $DEPLOY_DIR -Filter "*.jar" -ErrorAction SilentlyContinue
                if ($OLD_JARS) {
                    Write-Output "üì¶ Archivage des anciennes versions..."
                    foreach ($JAR in $OLD_JARS) {
                        $ARCHIVE_PATH = "$TODAY_ARCHIVE\$($JAR.Name)"
                        Move-Item -Path $JAR.FullName -Destination $ARCHIVE_PATH -Force
                        Write-Output "‚úÖ Archiv√©: $($JAR.Name) -> $ARCHIVE_PATH"
                    }
                } else {
                    Write-Output "‚ÑπÔ∏è  Aucun fichier JAR existant √† archiver"
                }
                
                # D√©ploiement du nouveau JAR
                Write-Output "üöÄ D√©ploiement de la nouvelle version..."
                $NEW_JAR = Get-ChildItem -Path $JAR_SOURCE -ErrorAction SilentlyContinue
                if ($NEW_JAR) {
                    Move-Item -Path $NEW_JAR.FullName -Destination $DEPLOY_DIR -Force
                    Write-Output "‚úÖ D√©ploy√©: $($NEW_JAR.Name) -> $DEPLOY_DIR"
                } else {
                    throw "‚ùå Aucun fichier JAR trouv√© dans C:\Windows\Temp\"
                }
                
                # Red√©marrage du service
                Write-Output "üîÑ D√©marrage du service $SERVICE_NAME..."
                C:\nssm\win64\nssm.exe start $SERVICE_NAME
                Start-Sleep -Seconds 2
                
                # V√©rification finale
                Write-Output "üìä Statut du service:"
                C:\nssm\win64\nssm.exe status $SERVICE_NAME
                
                # Nettoyage du fichier temporaire
                Write-Output "üßπ Nettoyage du fichier temporaire..."
                Remove-Item -Path $JAR_SOURCE -Force -ErrorAction SilentlyContinue
                
                Write-Output "`n‚úÖ D√©ploiement termin√© avec succ√®s!"
                
            } catch {
                Write-Output "‚ùå Erreur lors du d√©ploiement: $($_.Exception.Message)"
                Write-Output "Stack trace: $($_.ScriptStackTrace)"
                exit 1
            }
